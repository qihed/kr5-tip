<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–Ω–∏–≥–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container">
        <h1>üìñ –ö–Ω–∏–≥–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</h1>
        
        <div id="message" class="message"></div>
        
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø–æ –∏–º–µ–Ω–∏, —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏–ª–∏ email...">
        </div>
        
        <div class="form-section">
            <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–∞–∫—Ç</h2>
            <form id="contactForm">
                <div class="form-group">
                    <label for="name">–ò–º—è *</label>
                    <input type="text" id="name" required>
                </div>
                <div class="form-group">
                    <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                    <input type="text" id="phone" required>
                </div>
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email">
                </div>
                <div class="form-group">
                    <label for="address">–ê–¥—Ä–µ—Å</label>
                    <input type="text" id="address">
                </div>
                <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</button>
            </form>
        </div>
        
        <div id="contactsContainer">
            <div class="contacts-grid" id="contactsGrid"></div>
        </div>
    </div>
    
    <script>
        const API_URL = '/api/contacts';
        let contacts = [];
        let editingId = null;
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            loadContacts();
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
            document.getElementById('contactForm').addEventListener('submit', handleSubmit);
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∏—Å–∫–∞
            document.getElementById('searchInput').addEventListener('input', handleSearch);
        });
        
        // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
        async function loadContacts(searchTerm = '') {
            try {
                const url = searchTerm ? `${API_URL}?search=${encodeURIComponent(searchTerm)}` : API_URL;
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP –æ—à–∏–±–∫–∞! —Å—Ç–∞—Ç—É—Å: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    contacts = result.data;
                    renderContacts();
                } else {
                    showMessage(result.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:', error);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Express —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3000', 'error');
            }
        }
        
        // –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
        function handleSearch(e) {
            const searchTerm = e.target.value;
            loadContacts(searchTerm);
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        async function handleSubmit(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                address: document.getElementById('address').value
            };
            
            try {
                let response;
                if (editingId) {
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
                    response = await fetch(`${API_URL}/${editingId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                } else {
                    // –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });
                }
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP –æ—à–∏–±–∫–∞! —Å—Ç–∞—Ç—É—Å: ${response.status}. ${errorText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(editingId ? '–ö–æ–Ω—Ç–∞–∫—Ç –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ö–æ–Ω—Ç–∞–∫—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
                    document.getElementById('contactForm').reset();
                    editingId = null;
                    loadContacts();
                } else {
                    showMessage(result.message || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞:', error);
                if (error.message.includes('Failed to fetch') || error.message.includes('404') || error.message.includes('405')) {
                    showMessage('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Express —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (npm start) –∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –Ω–∞ http://localhost:3000', 'error');
                } else {
                    showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞: ' + error.message, 'error');
                }
            }
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
        async function deleteContact(id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–Ω—Ç–∞–∫—Ç?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP –æ—à–∏–±–∫–∞! —Å—Ç–∞—Ç—É—Å: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage('–ö–æ–Ω—Ç–∞–∫—Ç —É–¥–∞–ª–µ–Ω', 'success');
                    loadContacts();
                } else {
                    showMessage(result.message || '–û—à–∏–±–∫–∞', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞:', error);
                showMessage('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞', 'error');
            }
        }
        
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞
        function editContact(id) {
            const contact = contacts.find(c => c.id === id);
            if (!contact) return;
            
            document.getElementById('name').value = contact.name;
            document.getElementById('phone').value = contact.phone;
            document.getElementById('email').value = contact.email;
            document.getElementById('address').value = contact.address;
            
            editingId = id;
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —Ñ–æ—Ä–º–µ
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
        function renderContacts() {
            const grid = document.getElementById('contactsGrid');
            
            if (contacts.length === 0) {
                grid.innerHTML = '<p style="grid-column: 1/-1; text-align: center; color: #666;">–ö–æ–Ω—Ç–∞–∫—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>';
                return;
            }
            
            grid.innerHTML = contacts.map(contact => `
                <div class="contact-card">
                    <h3>${contact.name}</h3>
                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${contact.phone}</p>
                    <p><strong>Email:</strong> ${contact.email || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <p><strong>–ê–¥—Ä–µ—Å:</strong> ${contact.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <div class="contact-actions">
                        <button class="btn btn-success" onclick="editContact(${contact.id})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-danger" onclick="deleteContact(${contact.id})">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            `).join('');
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>

